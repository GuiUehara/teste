{% extends "base.html" %}

{% block content %}
<div class="contrato-container">
    <div class="form-container">
        <h2>Editar Locação #<span id="locacao-id-titulo"></span></h2>

        <div class="form-group">
            <label>Status:</label>
            <select id="status" onchange="verificarStatus()">
                <option value="Reserva">Reserva</option>
                <option value="Locado">Locado</option>
                <option value="Chegada">Chegada</option>
            </select>
        </div>

        <div class="form-group"><label>Data de saída:</label><input type="datetime-local" id="data_retirada"></div>
        <div class="form-group"><label>Data de chegada prevista:</label><input type="datetime-local" id="data_devolucao_prevista"></div>
        <div class="form-group" id="div_data_chegada_real" style="display: none;"><label>Data de chegada real:</label><input type="datetime-local" id="data_devolucao_real"></div>

        <hr>
        <h3>Cliente</h3>
        <div class="form-group"><label>Cliente:</label><input type="text" id="busca_cliente" readonly></div>
        <div class="form-group"><label>CPF:</label><input type="text" id="cpf" readonly></div>
        <div class="form-group"><label>CNH:</label><input type="text" id="cnh" readonly></div>
        <div class="form-group"><label>Data de validade da CNH:</label><input type="text" id="data_validade" readonly></div>

        <hr>
        <h3>Veículo</h3>
        <div class="form-group"><label>Marca:</label><input type="text" id="marca" readonly></div>
        <div class="form-group"><label>Modelo:</label><input type="text" id="modelo" readonly></div>
        <div class="form-group"><label>Placa:</label><input type="text" id="placa" readonly></div>

        <hr>
        <h3>Quilometragem</h3>
        <div class="form-group"><label>Quilometragem de saída:</label><input type="number" id="km_saida" readonly></div>
        <div class="form-group" id="div_km_chegada" style="display: none;"><label>Quilometragem de chegada:</label><input type="number" id="km_chegada"></div>

        <hr>
        <h3>Tanque</h3>
        <div class="form-group"><label>Tanque de saída:</label><input type="text" id="tanque_saida" readonly></div>
        <div class="form-group" id="div_tanque_chegada" style="display: none;"><label>Tanque de chegada:</label>
            <select id="tanque_chegada">
                <option value="8">Cheio</option>
                <option value="7">7/8</option>
                <option value="6">6/8</option>
                <option value="5">5/8</option>
                <option value="4">4/8</option>
                <option value="3">3/8</option>
                <option value="2">2/8</option>
                <option value="1">1/8</option>
                <option value="0">0/8</option>
            </select>
        </div>

        <hr>
        <h3>Opcionais</h3>
        <ul id="lista-opcionais"></ul>

        <hr>
        <h3>Caução</h3>
        <div class="form-group"><label>Valor da caução:</label><input type="number" id="caucao" step="0.01"></div>
        <div class="form-group">
            <label>Devolução:</label>
            <select id="devolucao">
                <option value="na devolução">Na devolução</option>
                <option value="5 dias">5 dias</option>
                <option value="15 dias">15 dias</option>
                <option value="30 dias">30 dias</option>
            </select>
        </div>

        <hr>
        <h3>Valores</h3>
        
        <!-- Valor Total Previsto (readonly) -->
        <div class="form-group">
            <label>Valor Total Previsto (R$):</label>
            <input type="number" id="valor_total_previsto" readonly>
        </div>

        <!-- Valor Final (realtime - visível apenas na Chegada) -->
        <div class="form-group" id="div_valor_final" style="display: none;">
            <label>Valor Final (R$):</label>
            <input type="number" id="valor_final" readonly>
        </div>
        <button type="button" onclick="atualizarLocacao()" class="btn-primary">Atualizar Locação</button>
    </div>

    <style>
    /* CSS ATUALIZADO: Mantido o estilo de largura total para o formulário */
    .contrato-container {
        width: 100%;
    }
    .form-container {
        width: 100%;
    }
    </style>

{% endblock %}

{% block scripts %}
<script>
    const idLocacao = {{ id_locacao }};

    // Função para formatar a data que vem do banco para o input datetime-local
    function formatarDataParaInput(dataString) {
        if (!dataString) return '';
        const data = new Date(dataString);
        // Ajusta para o fuso horário local
        const offset = data.getTimezoneOffset();
        const dataAjustada = new Date(data.getTime() - (offset * 60 * 1000));
        return dataAjustada.toISOString().slice(0, 16);
    }

    // Função para formatar a fração do tanque
    function formatarTanque(valor) {
        if (valor === null || valor === undefined) return '';
        return `${valor}/8`;
    }

    // Mapeia os IDs dos campos de chegada para adicionar os listeners
    const camposChegada = ['data_devolucao_real', 'km_chegada', 'tanque_chegada'];

    // Adiciona os listeners de evento (change ou input)
    function adicionarListenersCalculoFinal() {
        camposChegada.forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento) {
                // Usa 'input' para data/KM e 'change' para Selects
                const evento = (id === 'km_chegada' || id === 'data_devolucao_real') ? 'input' : 'change';
                elemento.addEventListener(evento, calcularValorFinalRealtime);
            }
        });
    }

    // Remove os listeners de evento
    function removerListenersCalculoFinal() {
        camposChegada.forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento) {
                const evento = (id === 'km_chegada' || id === 'data_devolucao_real') ? 'input' : 'change';
                elemento.removeEventListener(evento, calcularValorFinalRealtime);
            }
        });
    }

    // Rota de Simulação (POST) - CÁLCULO EM TEMPO REAL
    async function calcularValorFinalRealtime() {
        const status = document.getElementById('status').value;
        const dataDevolucaoReal = document.getElementById('data_devolucao_real').value;
        const kmChegada = document.getElementById('km_chegada').value;
        const tanqueChegada = document.getElementById('tanque_chegada').value; // Valor 0-8

        // Só calcula se estiver no status "Chegada" e tiver dados mínimos
        if (status !== 'Chegada' || !dataDevolucaoReal || kmChegada === '' || tanqueChegada === '') {
            document.getElementById('valor_final').value = '';
            return;
        }

        const dados = {
            data_devolucao_real: dataDevolucaoReal,
            km_chegada: parseFloat(kmChegada),
            tanque_chegada: parseInt(tanqueChegada)
        };
        
        // Limpa o valor final durante o cálculo
        document.getElementById('valor_final').value = 'Calculando...';

        try {
            const res = await fetch(`/api/locacao/calcular_final/${idLocacao}`, {
                method: "POST", 
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(dados)
            });

            const json = await res.json();
            
            if (res.ok) {
                // Atualiza o Valor Final com o resultado da simulação
                document.getElementById("valor_final").value = parseFloat(json.valor_final).toFixed(2);
            } else {
                console.error("Erro no cálculo em tempo real:", json.erro);
                document.getElementById('valor_final').value = 'Erro: ' + json.erro;
            }
        } catch(err) {
            console.error("Erro de conexão com a API de cálculo:", err);
            document.getElementById('valor_final').value = 'Erro API';
        }
    }


    // Função que popula o formulário
    function popularFormulario(data) {
        const locacao = data.locacao;
        const opcionais = data.opcionais;

        document.getElementById('locacao-id-titulo').textContent = locacao.id_locacao;
        document.getElementById('status').value = locacao.status;
        document.getElementById('data_retirada').value = formatarDataParaInput(locacao.data_retirada);
        document.getElementById('data_devolucao_prevista').value = formatarDataParaInput(locacao.data_devolucao_prevista);
        
        // Data de devolução real pode ser null
        if (locacao.data_devolucao_real) {
            document.getElementById('data_devolucao_real').value = formatarDataParaInput(locacao.data_devolucao_real);
        } else {
             document.getElementById('data_devolucao_real').value = '';
        }

        // Valor Total Previsto
        document.getElementById('valor_total_previsto').value = parseFloat(locacao.valor_total_previsto || 0).toFixed(2);
        
        // Cliente
        document.getElementById('busca_cliente').value = locacao.cliente_nome;
        document.getElementById('cpf').value = locacao.cliente_cpf;
        document.getElementById('cnh').value = locacao.cliente_cnh;
        document.getElementById('data_validade').value = locacao.cliente_validade;

        // Veículo
        document.getElementById('marca').value = locacao.marca;
        document.getElementById('modelo').value = locacao.modelo;
        document.getElementById('placa').value = locacao.placa;

        // Quilometragem
        document.getElementById('km_saida').value = locacao.quilometragem_retirada;
        document.getElementById('km_chegada').value = locacao.quilometragem_devolucao;

        // Tanque
        document.getElementById('tanque_saida').value = formatarTanque(locacao.tanque_saida);
        document.getElementById('tanque_chegada').value = locacao.tanque_chegada;

        // Caução
        document.getElementById('caucao').value = parseFloat(locacao.caucao || 0).toFixed(2);
        document.getElementById('devolucao').value = locacao.devolucao;

        // Opcionais
        const listaOpcionais = document.getElementById('lista-opcionais');
        listaOpcionais.innerHTML = '';
        if (opcionais && opcionais.length > 0) {
            opcionais.forEach(op => {
                const li = document.createElement('li');
                li.textContent = `${op.descricao} (Qtd: ${op.quantidade})`;
                listaOpcionais.appendChild(li);
            });
        } else {
            listaOpcionais.innerHTML = '<li>Nenhum opcional adicionado.</li>';
        }

        // Valor Final
        if (locacao.valor_final) {
            document.getElementById('valor_final').value = parseFloat(locacao.valor_final).toFixed(2);
        }
        
        verificarStatus(); // Ajusta a visibilidade e listeners
    }

    // Habilita/desabilita campos e listeners com base no status
    function verificarStatus() {
        const status = document.getElementById('status').value;
        const isChegada = status === 'Chegada';

        document.getElementById('div_data_chegada_real').style.display = isChegada ? 'block' : 'none';
        document.getElementById('div_km_chegada').style.display = isChegada ? 'block' : 'none';
        document.getElementById('div_tanque_chegada').style.display = isChegada ? 'block' : 'none';
        
        // Div Valor Final (somente na Chegada)
        document.getElementById('div_valor_final').style.display = isChegada ? 'block' : 'none';
        
        if (isChegada) {
            // ATIVAR LISTENERS
            adicionarListenersCalculoFinal();
            // Se já houver dados de chegada, calcula na hora da mudança de status
            calcularValorFinalRealtime(); 
        } else {
            // DESATIVAR LISTENERS
            removerListenersCalculoFinal();
        }
    }


    // Função para atualizar a locação
    async function atualizarLocacao() {
        const status = document.getElementById('status').value;
        const valorFinal = document.getElementById('valor_final').value;

        // Se o status for Chegada, verifica se o cálculo foi feito e se não deu erro
        if (status === 'Chegada' && (valorFinal === '' || isNaN(parseFloat(valorFinal)) || valorFinal.includes('Erro'))) {
            alert("Preencha todos os campos de chegada (data, km, tanque) e resolva erros de cálculo antes de atualizar.");
            return;
        }

        const dadosAtualizados = {
            status: status,
            data_retirada: document.getElementById('data_retirada').value,
            data_devolucao_prevista: document.getElementById('data_devolucao_prevista').value,
            // Envia null se não estiver na Chegada
            data_devolucao_real: status === 'Chegada' ? document.getElementById('data_devolucao_real').value : null,
            quilometragem_devolucao: status === 'Chegada' ? document.getElementById('km_chegada').value : null,
            tanque_chegada: status === 'Chegada' ? document.getElementById('tanque_chegada').value : null,
            caucao: document.getElementById('caucao').value,
            devolucao: document.getElementById('devolucao').value,
            // Envia o valor final calculado em tempo real para o banco salvar
            valor_final: status === 'Chegada' ? parseFloat(valorFinal) : null
        };

        try {
            // A rota PUT /api/locacao/id_locacao espera todos os dados da locação
            const response = await fetch(`/api/locacao/${idLocacao}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dadosAtualizados)
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.erro || 'Erro desconhecido ao atualizar.');
            }

            // Mostra a mensagem e redireciona após o usuário clicar em "OK"
            const mensagem = result.mensagem || 'Locação atualizada com sucesso!';
            alert(mensagem);
            window.location.href = "{{ url_for('locacao.historico_locacao') }}";

        } catch (error) {
            alert(`Erro: ${error.message}`);
            console.error('Falha ao atualizar locação:', error);
        }
    }

    // Carrega os dados da locação quando a página é carregada
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch(`/api/locacao/${idLocacao}`);
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.erro || 'Não foi possível carregar os dados da locação.');
            }
            popularFormulario(data);
        } catch (error) {
            alert(`Erro ao carregar dados: ${error.message}`);
            console.error(error);
        }
    });
</script>
{% endblock %}