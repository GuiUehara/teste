<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Cadastro de Locação</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-6">
<div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">

<h1 class="text-2xl font-bold mb-4">Cadastro de Locação</h1>

<!-- ===================== CAMPOS PRINCIPAIS ===================== -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">

  <!-- Cliente -->
  <div>
    <label>Cliente (CPF ou nome)</label>
    <input id="busca_cliente" class="border p-2 w-full" oninput="debounce(buscarCliente,300)">
    <div id="lista_clientes" class="border mt-1 max-h-40 overflow-y-auto hidden bg-white"></div>
  </div>

  <!-- Categoria -->
  <div>
    <label>Categoria</label>
    <select id="categoria" class="border p-2 w-full" onchange="carregarVeiculos()">
      <option value="">-- selecione --</option>
    </select>
  </div>

  <!-- Veículo -->
  <div>
    <label>Veículo</label>
    <select id="veiculo" class="border p-2 w-full" onchange="selecionarVeiculo()">
      <option value="">-- selecione --</option>
    </select>
  </div>

  <!-- Status -->
  <div>
    <label>Status</label>
    <select id="status" class="border p-2 w-full" onchange="onStatusChange()">
      <option value="Reserva">Reserva</option>
      <option value="Locado">Locado</option>
      <option value="Chegada">Chegada</option>
    </select>
  </div>

  <!-- Datas -->
  <div>
    <label>Data de retirada</label>
    <input id="data_retirada" type="datetime-local" class="border p-2 w-full">
  </div>
  <div>
    <label>Data devolução prevista</label>
    <input id="data_devolucao_prevista" type="datetime-local" class="border p-2 w-full" onchange="calcularPrevisto()">
  </div>
  <div>
    <label>Data devolução real</label>
    <input id="data_devolucao_real" type="datetime-local" class="border p-2 w-full" disabled>
  </div>

  <!-- KM -->
  <div>
    <label>KM saída</label>
    <input id="km_retirada" type="number" class="border p-2 w-full" readonly>
  </div>
  <div>
    <label>KM chegada</label>
    <input id="km_chegada" type="number" class="border p-2 w-full" disabled>
  </div>

  <!-- Tanques -->
  <div>
    <label>Tanque saída</label>
    <select id="tanque_saida" class="border p-2 w-full">
      <option value="8">8</option><option value="7">7</option><option value="6">6</option>
      <option value="5">5</option><option value="4">4</option><option value="3">3</option>
      <option value="2">2</option><option value="1">1</option>
    </select>
  </div>

  <div>
    <label>Tanque chegada</label>
    <select id="tanque_chegada" class="border p-2 w-full" disabled>
      <option value="">--</option>
      <option value="8">8</option><option value="7">7</option>
      <option value="6">6</option><option value="5">5</option>
      <option value="4">4</option><option value="3">3</option>
      <option value="2">2</option><option value="1">1</option>
    </select>
  </div>

  <!-- Caução -->
  <div>
    <label>Caução (R$)</label>
    <input id="caucao" type="number" step="0.01" class="border p-2 w-full" value="500.00">
  </div>

  <!-- Devolução -->
  <div>
    <label>Devolução</label>
    <select id="devolucao" class="border p-2 w-full">
      <option value="na devolução">Na devolução</option>
      <option value="5 dias">5 dias</option>
      <option value="15 dias">15 dias</option>
      <option value="30 dias">30 dias</option>
    </select>
  </div>

  <!-- Valor Previsto -->
  <div>
    <label>Valor previsto (R$)</label>
    <input id="valor_previsto" type="text" class="border p-2 w-full" readonly>
  </div>

</div>

<!-- ===================== OPCIONAIS ===================== -->
<h2 class="text-xl font-semibold mt-6">Opcionais</h2>

<div class="grid grid-cols-1 md:grid-cols-4 gap-2 mt-2">
  
  <select id="selectOpcional" class="border p-2 w-full">
    <option value="">Selecione um opcional</option>
    <option value="Cadeira de Bebê|25.00">Cadeira de Bebê — R$25</option>
    <option value="GPS|15.00">GPS — R$15</option>
    <option value="Bagageiro|40.00">Bagageiro — R$40</option>
  </select>

  <input id="quantOpcional" type="number" class="border p-2" placeholder="Qtd" min="1" step="1">

  <div></div>

  <button onclick="addOpcional()" class="bg-green-500 text-white p-2 rounded">Adicionar</button>

</div>

<table class="w-full border mt-4" id="tabelaOpcionais">
  <thead class="bg-gray-100">
    <tr>
      <th class="border p-2">Descrição</th>
      <th class="border p-2">Valor</th>
      <th class="border p-2">Qtd</th>
      <th class="border p-2">Ações</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- botão salvar -->
<button onclick="salvarLocacao()" class="mt-6 bg-blue-600 text-white p-3 rounded w-full">
  Salvar Locação
</button>

</div>

<!-- ===================== JAVASCRIPT ===================== -->
<script>
let clienteSelecionado=null;
let veiculoSelecionado=null;
let opcionaisTemp=[];

let debounceTimer;
function debounce(fn,ms){ clearTimeout(debounceTimer); debounceTimer=setTimeout(fn,ms); }

async function buscarCliente(){
  const termo=document.getElementById("busca_cliente").value.trim();
  const lista=document.getElementById("lista_clientes");

  if(!termo){ lista.classList.add("hidden"); lista.innerHTML=""; return; }

  const r=await fetch("/api/clientes?termo="+encodeURIComponent(termo));
  const data=await r.json();

  lista.innerHTML="";
  if(!data.length){ lista.classList.add("hidden"); return; }

  data.forEach(c=>{
    const d=document.createElement("div");
    d.textContent=c.texto;
    d.className="p-2 hover:bg-gray-200 cursor-pointer";
    d.onclick=()=>{ clienteSelecionado=c; document.getElementById("busca_cliente").value=c.texto; lista.classList.add("hidden"); };
    lista.appendChild(d);
  });

  lista.classList.remove("hidden");
}

async function carregarCategorias(){
  const r=await fetch("/api/categorias");
  const data=await r.json();
  const sel=document.getElementById("categoria");

  sel.innerHTML='<option value="">-- selecione --</option>';
  data.forEach(c=>{
    const op=document.createElement("option");
    op.value=c.id_categoria_veiculo;
    op.textContent=c.nome_categoria;
    op.dataset.valor=c.valor_diaria;
    sel.appendChild(op);
  });
}
carregarCategorias();

async function carregarVeiculos(){
  const cat=document.getElementById("categoria").value;
  const r=await fetch("/api/veiculos?categoria_id="+cat);
  const data=await r.json();
  const sel=document.getElementById("veiculo");

  sel.innerHTML='<option value="">-- selecione --</option>';
  data.forEach(v=>{
    const op=document.createElement("option");
    op.value=v.id_veiculo;
    op.textContent=v.placa+" - "+v.nome_modelo;
    op.dataset.valor=v.valor_diaria;
    op.dataset.km=v.quilometragem;
    sel.appendChild(op);
  });
}

function selecionarVeiculo(){
  const op=document.getElementById("veiculo").selectedOptions[0];
  veiculoSelecionado=op;
  document.getElementById("km_retirada").value = op ? op.dataset.km : "";
  calcularPrevisto();
}

function onStatusChange(){
  const st=document.getElementById("status").value;
  document.getElementById("km_chegada").disabled = st!=="Chegada";
  document.getElementById("tanque_chegada").disabled = st!=="Chegada";
  document.getElementById("data_devolucao_real").disabled = st!=="Chegada";
}

function calcularPrevisto(){
  const dr=document.getElementById("data_retirada").value;
  const dd=document.getElementById("data_devolucao_prevista").value;
  if(!dr || !dd || !veiculoSelecionado){ document.getElementById("valor_previsto").value=""; return; }

  const d1=new Date(dr), d2=new Date(dd);
  let dias=Math.ceil((d2-d1)/(1000*60*60*24));
  dias=Math.max(1,dias);

  const valor=parseFloat(veiculoSelecionado.dataset.valor || 0);
  document.getElementById("valor_previsto").value = (dias*valor).toFixed(2);
}

function addOpcional(){
  const val=document.getElementById("selectOpcional").value;
  const q=parseInt(document.getElementById("quantOpcional").value);
  if(!val || !q){ alert("Selecione e informe quantidade."); return; }

  const [desc, valor]=val.split("|");
  opcionaisTemp.push({ descricao: desc, valor_diaria: parseFloat(valor), quantidade: q });

  atualizarOpcionalTabela();
  document.getElementById("selectOpcional").value="";
  document.getElementById("quantOpcional").value="";
}

function atualizarOpcionalTabela(){
  const tbody=document.querySelector("#tabelaOpcionais tbody");
  tbody.innerHTML="";
  opcionaisTemp.forEach((o,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="border p-2">${o.descricao}</td>
      <td class="border p-2">${o.valor_diaria.toFixed(2)}</td>
      <td class="border p-2">${o.quantidade}</td>
      <td class="border p-2">
        <button class="bg-red-500 text-white p-1 rounded" onclick="opcionaisTemp.splice(${i},1); atualizarOpcionalTabela();">X</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function salvarLocacao(){
  if(!clienteSelecionado || !veiculoSelecionado){ alert("Selecione cliente e veículo."); return; }

  const payload={
    id_cliente: clienteSelecionado.id_cliente,
    id_veiculo: veiculoSelecionado.value,
    data_retirada: document.getElementById("data_retirada").value,
    data_devolucao_prevista: document.getElementById("data_devolucao_prevista").value,
    quilometragem_retirada: document.getElementById("km_retirada").value,
    tanque_saida: document.getElementById("tanque_saida").value,
    caucao: document.getElementById("caucao").value,
    devolucao: document.getElementById("devolucao").value,
    status: document.getElementById("status").value,
    valor_diaria: veiculoSelecionado.dataset.valor,
    opcionais: opcionaisTemp
  };

  if(payload.status==="Chegada"){
    payload.quilometragem_devolucao=document.getElementById("km_chegada").value;
    payload.tanque_chegada=document.getElementById("tanque_chegada").value;
    payload.data_devolucao_real=document.getElementById("data_devolucao_real").value;
  }

  const r=await fetch("/api/cadastrar",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });

  const data=await r.json();

  if(r.ok){
    alert("Locação salva com sucesso!");
    opcionaisTemp=[];
    atualizarOpcionalTabela();
  } else {
    alert("Erro ao salvar: " + (data.erro || JSON.stringify(data)));
  }
}
</script>

</body>
</html>
