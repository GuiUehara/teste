<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Contrato – Primeira Parte</title>
</head>
<body>

<h2>Contrato de Locação</h2>

<div>
    <label>Status:</label>
    <select id="status" onchange="verificarStatus()">
        <option value="Reserva">Reserva</option>
        <option value="Locado">Locado</option>
        <option value="Chegada">Chegada</option>
    </select>
</div>

<div>
    <label>Data de saída:</label>
    <input type="datetime-local" id="data_retirada">
</div>

<div>
    <label>Data de chegada prevista:</label>
    <input type="datetime-local" id="data_devolucao_prevista">
</div>

<div>
    <label>Data de chegada real:</label>
    <input type="datetime-local" id="data_devolucao_real">
</div>

<h2>Cliente</h2>

<div>
    <label>Cliente (Nome ou CPF):</label>
    <input type="text" id="busca_cliente" oninput="autocompleteCliente()" autocomplete="off">
    <ul id="lista_clientes" style="border:1px solid #ccc; max-width:300px; display:none; position:absolute; list-style:none; padding:0; margin:0;"></ul>
</div>

<div>
    <label>CPF:</label>
    <input type="text" id="cpf" readonly>
</div>

<div>
    <label>CNH:</label>
    <input type="text" id="cnh" readonly>
</div>

<div>
    <label>Data de validade da CNH:</label>
    <input type="text" id="data_validade" readonly>
</div>

<h2>Categoria e Veículo</h2>

<div>
    <label>Categoria:</label>
    <select id="categoria" onchange="carregarVeiculos()">
        <option value="">Selecione a categoria</option>
    </select>
</div>

<div>
    <label>Veículo:</label>
    <select id="veiculo">
        <option value="">Selecione o veículo</option>
    </select>
</div>

<h2>Quilometragem</h2>

<div>
    <label>Quilometragem de saída:</label>
    <input type="number" id="km_saida" disabled>
</div>

<div>
    <label>Quilometragem de chegada:</label>
    <input type="number" id="km_chegada">
</div>

<h2>Tanque</h2>

<div>
    <label>Tanque de saída:</label>
    <select id="tanque_saida" disabled>
        <option value="8">Cheio</option>
        <option value="7">7/8</option>
        <option value="6">6/8</option>
        <option value="5">5/8</option>
        <option value="4">4/8</option>
        <option value="3">3/8</option>
        <option value="2">2/8</option>
        <option value="1">1/8</option>
        <option value="0">0/8</option>
    </select>
</div>

<div>
    <label>Tanque de chegada:</label>
    <select id="tanque_chegada">
        <option value="8">Cheio</option>
        <option value="7">7/8</option>
        <option value="6">6/8</option>
        <option value="5">5/8</option>
        <option value="4">4/8</option>
        <option value="3">3/8</option>
        <option value="2">2/8</option>
        <option value="1">1/8</option>
        <option value="0">0/8</option>
    </select>
</div>

<div id="opcionais-section">
    <h3>Opcionais da Locação</h3>
    
    <!-- Lista de opcionais -->
    <ul id="lista-opcionais"></ul>

    <!-- Adicionar opcionais -->
    <h4>Adicionar Opcional</h4>
    <select id="select-opcional"></select>
    <input type="number" id="quantidade-opcional" value="1" min="1" />
    <button id="btn-adicionar-opcional">Adicionar</button>
</div>

<h2>Caução</h2>
<div>
    <label>Valor da caução:</label>
    <input type="number" id="caucao" step="0.01">
</div>

<div>
    <label>Devolução:</label>
    <select id="devolucao">
        <option value="na devolução">Na devolução</option>
        <option value="5 dias">5 dias</option>
        <option value="15 dias">15 dias</option>
        <option value="30 dias">30 dias</option>
    </select>
</div>

<button onclick="salvarLocacaoFront()">Salvar</button>

<script>
let idLocacao = null; // se locação já existir
let opcionaisTemp = []; // opcionais temporários

// ------------ Funções ------------

// Carregar categorias
function carregarCategorias() {
    fetch('/api/categorias')
        .then(res => res.json())
        .then(categorias => {
            const select = document.getElementById("categoria");
            categorias.forEach(cat => {
                const option = document.createElement("option");
                option.value = cat.id;
                option.textContent = cat.nome;
                select.appendChild(option);
            });
        });
}

// Carregar veículos
function carregarVeiculos() {
    const id_categoria = document.getElementById("categoria").value;
    const selectVeiculo = document.getElementById("veiculo");
    selectVeiculo.innerHTML = '<option value="">Selecione o veículo</option>';
    if (!id_categoria) return;
    fetch(`/api/veiculos?id_categoria=${id_categoria}`)
        .then(res => res.json())
        .then(veiculos => {
            veiculos.forEach(v => {
                const option = document.createElement("option");
                option.value = v.id;
                option.textContent = v.descricao;
                selectVeiculo.appendChild(option);
            });
        });
}

// Habilitar/desabilitar campos
function verificarStatus() {
    const status = document.getElementById("status").value;
    document.getElementById("data_devolucao_real").disabled = status !== "Chegada";
    document.getElementById("km_chegada").disabled = status !== "Chegada";
    document.getElementById("tanque_chegada").disabled = status !== "Chegada";
}

// Autocomplete clientes
function autocompleteCliente() {
    const termo = document.getElementById("busca_cliente").value.trim();
    const lista = document.getElementById("lista_clientes");
    lista.innerHTML = "";
    if (!termo) { lista.style.display = "none"; return; }
    fetch(`/api/clientes?termo=${encodeURIComponent(termo)}`)
        .then(res => res.json())
        .then(clientes => {
            if (!clientes || clientes.length === 0) { lista.style.display = "none"; return; }
            clientes.forEach(c => {
                const li = document.createElement("li");
                li.textContent = `${c.nome_completo} (${c.cpf})`;
                li.style.cursor = "pointer";
                li.onclick = () => {
                    document.getElementById("busca_cliente").value = c.nome_completo;
                    document.getElementById("cpf").value = c.cpf;
                    document.getElementById("cnh").value = c.cnh;
                    document.getElementById("data_validade").value = c.data_validade;
                    lista.style.display = "none";
                };
                lista.appendChild(li);
            });
            lista.style.display = "block";
        });
}
document.addEventListener('click', function(e) {
    const lista = document.getElementById("lista_clientes");
    if (!document.getElementById("busca_cliente").contains(e.target)) lista.style.display = "none";
});

// -------- Opcionais --------
function carregarOpcionais() {
    fetch('/api/opcionais')
        .then(res => res.json())
        .then(opcionais => {
            const select = document.getElementById("select-opcional");
            select.innerHTML = "";
            opcionais.forEach(o => {
                const option = document.createElement("option");
                option.value = o.id_opcional;
                option.textContent = `${o.descricao} - R$${o.valor_diaria.toFixed(2)}`;
                select.appendChild(option);
            });
        });
}

// Adicionar opcional temporário
function adicionarOpcionalTemp() {
    const select = document.getElementById("select-opcional");
    const quantidade = parseInt(document.getElementById("quantidade-opcional").value);
    const id_opcional = parseInt(select.value);
    const descricao = select.options[select.selectedIndex].text;
    if (!id_opcional || quantidade < 1) return;

    const existente = opcionaisTemp.find(o => o.id_opcional === id_opcional);
    if (existente) existente.quantidade += quantidade;
    else opcionaisTemp.push({ id_opcional, descricao, quantidade });

    listarOpcionaisTemp();
}

// Listar opcionais temporários
function listarOpcionaisTemp() {
    const lista = document.getElementById("lista-opcionais");
    lista.innerHTML = "";
    opcionaisTemp.forEach((op, idx) => {
        const li = document.createElement("li");
        li.textContent = `${op.descricao} - Qtd: ${op.quantidade} `;
        const btn = document.createElement("button");
        btn.textContent = "Remover";
        btn.onclick = () => { opcionaisTemp.splice(idx,1); listarOpcionaisTemp(); };
        li.appendChild(btn);
        lista.appendChild(li);
    });
}

// Salvar locação + opcionais
async function salvarLocacaoFront() {
    const dadosLocacao = {
        status: document.getElementById("status").value,
        data_retirada: document.getElementById("data_retirada").value,
        data_devolucao_prevista: document.getElementById("data_devolucao_prevista").value,
        data_devolucao_real: document.getElementById("data_devolucao_real").value,
        quilometragem_devolucao: document.getElementById("km_chegada").value,
        tanque_chegada: document.getElementById("tanque_chegada").value,
        caucao: parseFloat(document.getElementById("caucao").value),
        devolucao: document.getElementById("devolucao").value
    };

    // Criar locação
    const res = await fetch("/api/locacao", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(dadosLocacao)
    });
    if (!res.ok) { const e = await res.json(); alert("Erro: "+e.erro); return; }
    const loc = await res.json();
    idLocacao = loc.id_locacao;

    // Enviar opcionais
    if (opcionaisTemp.length > 0) {
        const resOpc = await fetch(`/api/locacao/${idLocacao}/opcionais`, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(opcionaisTemp.map(op => ({id_opcional: op.id_opcional, quantidade: op.quantidade})))
        });
        if (!resOpc.ok) { const e = await resOpc.json(); alert("Erro opcionais: "+e.erro); return; }
    }

    alert("Locação e opcionais cadastrados com sucesso!");
    opcionaisTemp = [];
    listarOpcionaisTemp();
}

// -------- Inicialização --------
window.onload = function() {
    carregarCategorias();
    carregarOpcionais();
    verificarStatus();
    document.getElementById("btn-adicionar-opcional").addEventListener("click", adicionarOpcionalTemp);
};
</script>

</body>
</html>
