{% extends "base.html" %}

{% block content %}
<div class="form-container">
    <h2>Contrato de Locação</h2>
    <form id="form-locacao">
        <div class="form-group">
        <label>Status:</label>
        <select id="status">
            <option value="Reserva">Reserva</option>
            <option value="Locado">Locado</option>
            </select>
    </div>
        <div class="form-group"><label>Data de saída:</label><input type="datetime-local" id="data_retirada"></div>
        <div class="form-group"><label>Data de chegada prevista:</label><input type="datetime-local" id="data_devolucao_prevista"></div>
        
        <hr>
    <h3>Cliente</h3>

    <div class="form-group" style="position: relative;">
        <label>Cliente (Nome ou CPF):</label>
        <input type="text" id="busca_cliente" oninput="autocompleteCliente()" autocomplete="off">
        <ul id="lista_clientes" style="display:none;"></ul>
    </div>

    <div class="form-group">
        <label>CPF:</label>
        <input type="text" id="cpf" readonly>
        <input type="hidden" id="id_cliente" name="id_cliente">
    </div>

    <div class="form-group"><label>CNH:</label><input type="text" id="cnh" readonly></div>
    <div class="form-group"><label>Data de validade da CNH:</label><input type="text" id="data_validade" readonly></div>

    <hr>
    <h3>Categoria e Veículo</h3>

    <div class="form-group">
        <label>Categoria:</label>
        <select id="categoria" onchange="carregarVeiculos()">
            <option value="">Selecione a categoria</option>
        </select>
    </div>

    <div class="form-group">
        <label>Veículo:</label>
        <select id="veiculo">
            <option value="">Selecione o veículo</option>
        </select>
    </div>

    <hr>
    <h3>Quilometragem</h3>
    <div class="form-group"><label>Quilometragem de saída:</label><input type="number" id="km_saida" readonly></div>
    
    <hr>
    <h3>Tanque</h3>
    <div class="form-group">
    <label>Tanque de saída:</label>
    <select id="tanque_saida"> 
        <option value="8">Cheio (8/8)</option>
        <option value="7">7/8</option>
        <option value="6">6/8</option>
        <option value="5">5/8</option>
        <option value="4">4/8</option>
        <option value="3">3/8</option>
        <option value="2">2/8</option>
        <option value="1">1/8</option>
        <option value="0">0/8</option>
    </select>
    </div>

    <hr>
    <div class="opcionais-section">
        <h3>Adicionar Opcional</h3>
        <div class="form-group cep-group">
            <select id="select-opcional"></select>
            <input type="number" id="quantidade-opcional" value="1" min="1" />
            
            <button type="button" id="btn-adicionar-opcional" class="btn btn-secondary">Adicionar</button>
        </div>
        <ul id="lista-opcionais"></ul>
    </div>

    <hr>
    <h3>Caução</h3>
    <div class="form-group"><label>Valor da caução:</label><input type="number" id="caucao" step="0.01"></div>
    <div class="form-group">
        <label>Devolução:</label>
        <select id="devolucao">
            <option value="Não devolvido">Não devolvido</option>
            <option value="Devolvido">Devolvido</option>
        </select>
    </div>

    <hr>
    <h3>Valores</h3>

    <div class="form-group"><label>Valor total previsto:</label><input type="number" id="valor_total_previsto" name="valor_total_previsto" readonly></div>
    </form>

    <button onclick="salvarLocacaoFront()" class="btn-primary" style="margin-top: 20px;">Salvar</button>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/api.js') }}"></script>
<script src="{{ url_for('static', filename='js/locacao.js') }}"></script>

<script>
// --- FUNÇÕES AUXILIARES PARA GARANTIR VALORES NUMÉRICOS NO BANCO ---

/**
 * Converte um valor para inteiro de forma segura, retornando 8 (tanque cheio) como padrão se o valor for inválido ou nulo.
 * Essencial para campos que não podem ser nulos no banco de dados, como 'tanque_saida'.
 */
const safeParseIntNotNull = (value) => {
    const parsed = parseInt(value);
    // Se a conversão falhar (NaN) ou o valor for null/vazio, retorna 8 (Cheio, como fallback)
    return isNaN(parsed) ? 8 : parsed;
};

/**
 * Converte um valor para inteiro, retornando `null` se o valor for inválido ou vazio.
 * Usado para campos que podem ser nulos no banco, como os campos de chegada que foram removidos deste formulário.
 */
const safeParseInt = (value) => {
    if (!value) return null; 
    const parsed = parseInt(value);
    return isNaN(parsed) ? null : parsed;
};

/**
 * Ponto de entrada do script. É executado quando o HTML da página foi completamente carregado.
 * Inicializa os componentes da página, como o carregamento de categorias e opcionais,
 * e configura os listeners de eventos para os botões e campos do formulário.
 */
document.addEventListener("DOMContentLoaded", function() {
    // Inicializações
    carregarCategorias();
    carregarOpcionais('select-opcional'); // Função do locacao.js
    
    // Event Listeners
    const btnAdd = document.getElementById("btn-adicionar-opcional");
    if(btnAdd) {
        btnAdd.addEventListener("click", () => {
            adicionarOpcionalTemp('select-opcional', 'quantidade-opcional');
        });
    }
    
    /**
     * Listener de evento para o campo de seleção de veículo.
     * Quando um veículo é selecionado, esta função busca os detalhes (quilometragem, caução, tanque)
     * na API e preenche automaticamente os campos correspondentes no formulário.
     */
    // Adiciona o listener para o campo de veículo
    document.getElementById("veiculo").addEventListener("change", async (event) => {
        const idVeiculo = event.target.value;
        const campoKmSaida = document.getElementById("km_saida");
        const campoCaucao = document.getElementById("caucao");
        const campoTanqueSaida = document.getElementById("tanque_saida");

        // Limpa os campos se nenhum veículo for selecionado
        if (!idVeiculo) {
            campoKmSaida.value = "";
            campoCaucao.value = "";
            campoTanqueSaida.value = "8"; // Padrão
            return;
        }

        try {
            const veiculo = await fetchDetalhesVeiculo(idVeiculo);

            // Preenche os campos com os dados da API
            campoKmSaida.value = veiculo.quilometragem || "";
            campoCaucao.value = veiculo.valor_caucao ? parseFloat(veiculo.valor_caucao).toFixed(2) : "0.00";
            campoTanqueSaida.value = Math.round(parseFloat(veiculo.tanque_fracao)) || 8;

        } catch (error) {
            console.error("Erro ao preencher dados do veículo:", error);
            alert("Não foi possível carregar os dados do veículo selecionado.");
        }
    });

    document.getElementById("data_retirada").addEventListener("change", atualizarValorPrevisto);
    document.getElementById("data_devolucao_prevista").addEventListener("change", atualizarValorPrevisto);
    document.addEventListener('opcionaisAtualizados', atualizarValorPrevisto);

    /**
     * Listener de evento global para cliques na página.
     * Usado para fechar a lista de sugestões do autocomplete de clientes quando o usuário clica fora dela.
     */
    // Fecha autocomplete ao clicar fora
    document.addEventListener('click', function(e) {
        const lista = document.getElementById("lista_clientes");
        const input = document.getElementById("busca_cliente");
        // Verifica se a lista existe, o input existe e se o clique não foi no input ou na lista
        if (lista && input && !input.contains(e.target) && !lista.contains(e.target)) {
            lista.style.display = "none";
        }
    });
});

// --- FUNÇÕES DE INTERFACE DA PÁGINA (Ajustadas) ---

/**
 * Carrega as categorias de veículos da API e popula o campo <select> de categorias no formulário.
 */
function carregarCategorias() {
    fetchCategorias().then(categorias => {
        const select = document.getElementById("categoria");
        select.innerHTML = '<option value="">Selecione a categoria</option>';
        categorias.forEach(cat => {
            const option = document.createElement("option");
            option.value = cat.id;
            option.textContent = cat.nome;
            select.appendChild(option);
        });
    }).catch(err => console.error(err));
}

/**
 * Carrega os veículos disponíveis para uma categoria selecionada.
 * É chamada sempre que o valor do <select> de categoria é alterado.
 */
function carregarVeiculos() {
    const id_categoria = document.getElementById("categoria").value;
    const selectVeiculo = document.getElementById("veiculo");
    selectVeiculo.innerHTML = '<option value="">Selecione o veículo</option>';
    
    if (!id_categoria) return;

    fetchVeiculosPorCategoria(id_categoria).then(veiculos => {
        veiculos.forEach(v => {
            const option = document.createElement("option");
            option.value = v.id;
            option.textContent = v.descricao;
            selectVeiculo.appendChild(option);
        });
    }).catch(err => console.error(err));
}

/**
 * Realiza a busca de clientes na API conforme o usuário digita no campo de busca.
 * Exibe uma lista de sugestões e, ao selecionar um cliente, preenche automaticamente
 * os campos de CPF, CNH e ID do cliente.
 */
function autocompleteCliente() {
    const termo = document.getElementById("busca_cliente").value.trim();
    const lista = document.getElementById("lista_clientes");
    
    lista.innerHTML = "";
    if (!termo) { lista.style.display = "none"; return; }
    
    fetch(`/api/clientes?termo=${encodeURIComponent(termo)}`)
        .then(res => res.json())
        .then(clientes => {
            if (!clientes || clientes.length === 0) { lista.style.display = "none"; return; }
            
            clientes.forEach(c => {
                const li = document.createElement("li");
                li.textContent = `${c.nome_completo} (${c.cpf})`;
                li.style.cssText = "cursor: pointer; padding: 8px; border-bottom: 1px solid #eee; background: #fff;";
                li.onmouseover = () => li.style.background = "#f0f0f0";
                li.onmouseout = () => li.style.background = "#fff";
                
                li.onclick = () => {
                    document.getElementById("busca_cliente").value = c.nome_completo;
                    document.getElementById("cpf").value = c.cpf;
                    document.getElementById("id_cliente").value = c.id_cliente;
                    
                    if(document.getElementById("cnh")) document.getElementById("cnh").value = c.cnh || "";
                    if(document.getElementById("data_validade")) document.getElementById("data_validade").value = c.data_validade || "";
                    
                    lista.style.display = "none";
                };
                lista.appendChild(li);
            });
            lista.style.display = "block";
            lista.style.border = "1px solid #ccc";
            lista.style.position = "absolute";
            lista.style.width = "100%";
            lista.style.zIndex = "1000";
            lista.style.maxHeight = "200px";
            lista.style.overflowY = "auto";
        })
        .catch(err => console.error("Erro autocomplete:", err));
}

/**
 * Calcula o valor total previsto da locação em tempo real.
 * É chamada sempre que as datas de retirada/devolução ou a lista de opcionais são alteradas.
 * Envia os dados para a API '/api/valor-previsto' e atualiza o campo correspondente no formulário.
 */
async function atualizarValorPrevisto() {
    const idVeiculo = document.getElementById("veiculo").value;
    const dataRetirada = document.getElementById("data_retirada").value;
    const dataPrevista = document.getElementById("data_devolucao_prevista").value;

    if (!idVeiculo || !dataRetirada || !dataPrevista) return;

    const dados = {
        id_veiculo: parseInt(idVeiculo),
        data_retirada: dataRetirada,
        data_devolucao_prevista: dataPrevista,
        opcionais: opcionaisTemp.map(op => ({ // Usa a variável que vem do locacao.js
            id_opcional: op.id_opcional,
            quantidade: op.quantidade
        }))
    };

    try {
        const res = await fetch("/api/valor-previsto", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(dados)
        });
        if (res.ok) {
            const json = await res.json();
            if (json.valor_total_previsto !== undefined) {
                document.getElementById("valor_total_previsto").value = json.valor_total_previsto.toFixed(2);
            }
        }
    } catch(err) {
        console.error("Erro calculo:", err);
    }
}

/**
 * Coleta todos os dados do formulário, monta um objeto JSON e o envia para a API
 * para criar uma nova locação no banco de dados. Exibe mensagens de sucesso ou erro
 * e recarrega a página após o sucesso.
 */
async function salvarLocacaoFront() {
    if(!document.getElementById("id_cliente").value) {
        alert("Selecione um cliente.");
        return;
    }
    
    // Os campos de chegada, como 'data_devolucao_real', 'quilometragem_devolucao' e 'tanque_chegada'
    // agora enviarão NULL (ou string vazia) para o backend

    const dadosLocacao = {
        status: document.getElementById("status").value,
        data_retirada: document.getElementById("data_retirada").value,
        data_devolucao_prevista: document.getElementById("data_devolucao_prevista").value,
        
        // Estes campos agora serão enviados como NULL ou string vazia, pois foram removidos do HTML.
        data_devolucao_real: null,
        quilometragem_devolucao: null,
        tanque_chegada: null, 
        
        caucao: parseFloat(document.getElementById("caucao").value) || 0,
        devolucao: document.getElementById("devolucao").value,
        id_cliente: parseInt(document.getElementById("id_cliente").value),
        id_veiculo: parseInt(document.getElementById("veiculo").value),
        quilometragem_saida: document.getElementById("km_saida").value,
        
        // Usa safeParseIntNotNull (INT NOT NULL)
        tanque_saida: safeParseIntNotNull(document.getElementById("tanque_saida").value),
        
        valor_total_previsto: parseFloat(document.getElementById("valor_total_previsto").value) || 0,
        opcionais: opcionaisTemp.map(op => ({
            id_opcional: op.id_opcional,
            quantidade: op.quantidade
        }))
    };

    try {
        const res = await fetch("/api/locacao", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(dadosLocacao)
        });

        if (!res.ok) {
            const texto = await res.text();
            let erroMsg = "Erro desconhecido";
            try { erroMsg = JSON.parse(texto).erro; } catch(e) { erroMsg = texto; }
            alert("Erro: " + erroMsg);
            return;
        }

        alert("Sucesso!");
        window.location.reload(); // Recarrega a página para limpar tudo
        
    } catch (err) {
        console.error(err);
        alert("Erro de conexão.");
    }
}
</script>
{% endblock %}