{% extends "base.html" %}

{% block content %}
<div class="form-container">
    <h2>Cadastro de Veículo</h2>

    <form method="POST" action="{{ url_for('veiculos.cadastro_veiculo') }}" id="formVeiculo">
        <div class="form-group"><label for="placaVeiculo">Placa</label><input type="text" name="placaVeiculo" id="placaVeiculo" required /></div>
        <div class="form-group"><label for="chassiVeiculo">Chassi</label><input type="text" name="chassiVeiculo" id="chassiVeiculo" required /></div>
        <div class="form-group"><label for="anoVeiculo">Ano</label><input type="number" name="anoVeiculo" id="anoVeiculo" required /></div>
        <div class="form-group"><label for="corVeiculo">Cor</label><input type="text" name="corVeiculo" id="corVeiculo" required /></div>

        <div class="form-group">
            <label for="transmissaoVeiculo">Transmissão</label>
            <select name="transmissaoVeiculo" id="transmissaoVeiculo" required>
                <option value="">Selecione</option>
                <option value="manual">Manual</option>
                <option value="automatico">Automático</option>
            </select>
        </div>

        <div class="form-group"><label for="dataCompra">Data da Compra</label><input type="date" name="dataCompra" id="dataCompra" required /></div>
        <div class="form-group"><label for="valorCompra">Valor da Compra</label><input type="number" step="0.01" name="valorCompra" id="valorCompra" required /></div>
        <div class="form-group"><label for="odometro">Odômetro</label><input type="number" name="odometro" id="odometro" required /></div>
        <div class="form-group"><label for="vencimentoLicenciamento">Vencimento Licenciamento</label><input type="date" name="vencimentoLicenciamento" id="vencimentoLicenciamento" required /></div>
        <div class="form-group"><label for="tanque">Tanque (litros)</label><input type="number" name="tanque" id="tanque" required /></div>

        <div class="form-group">
            <label for="tanqueFracao">Tanque Fração</label>
            <select name="tanqueFracao" id="tanqueFracao" required>
                <option value="8">Cheio (1/1)</option>
                <option value="7">7/8</option>
                <option value="6">6/8</option>
                <option value="5">5/8</option>
                <option value="4">4/8</option>
                <option value="3">3/8</option>
                <option value="2">2/8</option>
                <option value="1">1/8</option>
                <option value="0">0/8</option>
            </select>
        </div>

        <div class="form-group">
            <label for="combustivel">Combustível</label>
            <select name="combustivel" id="combustivel" required>
                <option value="">Selecione</option>
                {% for comb in combustiveis %}
                    <option value="{{ comb.id_combustivel }}">{{ comb.tipo_combustivel }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="marca">Marca</label>
            <select name="marca" id="marca" required>
                <option value="">Selecione</option>
                {% for m in marcas %}
                    <option value="{{ m.id_marca }}">{{ m.nome_marca }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="modeloVeiculo">Modelo</label>
            <select name="modeloVeiculo" id="modeloVeiculo" required>
                <option value="">Selecione uma marca primeiro</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="categoria">Categoria</label>
            <input type="text" name="categoria" id="categoria" readonly placeholder="Automático" />
        </div>

        <div class="form-group">
            <label for="status">Status</label>
            <select name="status" id="status" required>
                <option value="">Selecione</option>
                {% for s in status %}
                    <option value="{{ s.id_status_veiculo }}">{{ s.descricao_status }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="companhiaSeguro">Companhia Seguro</label>
            <select name="companhiaSeguro" id="companhiaSeguro">
                <option value="">Selecione</option>
                {% for c in seguros %}
                    <option value="{{ c.id_seguro }}">{{ c.companhia }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group"><label for="vencimentoSeguro">Vencimento Seguro</label><input type="date" name="vencimentoSeguro" id="vencimentoSeguro"/></div>

        <button type="submit" class="btn-primary">Registrar Veículo</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const selectMarca = document.getElementById("marca");
    const selectModelo = document.getElementById("modeloVeiculo");
    const inputCategoria = document.getElementById("categoria");

    // Ao mudar a marca, carrega os modelos correspondentes
    selectMarca.addEventListener("change", e => {
        const marcaId = e.target.value;
        selectModelo.innerHTML = '<option value="">Selecione um modelo</option>';
        inputCategoria.value = ""; // Limpa categoria

        if (!marcaId) return;

        fetch(`/api/modelos/${marcaId}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(m => {
                    const option = document.createElement("option");
                    option.value = m.id;
                    option.textContent = m.nome;
                    option.setAttribute("data-categoria", m.id_categoria_nome); // vamos enviar o nome da categoria na API
                    selectModelo.appendChild(option);
                });
            });
    });

    // Ao mudar o modelo, preenche automaticamente a categoria
    selectModelo.addEventListener("change", e => {
        const selected = e.target.selectedOptions[0];
        const categoriaNome = selected?.getAttribute("data-categoria");
        inputCategoria.value = categoriaNome || "";
    });
});
</script>

{% endblock %}
